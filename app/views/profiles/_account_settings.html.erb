<%# Account Settings Partial %>
<%# Displays account management content in the Account tab %>
<%# Inline form for updating email and password via Devise %>

<div class="space-y-6">
  <h2 class="block antialiased font-sans text-2xl font-semibold leading-snug text-blue-gray-900">
    Account Settings
  </h2>
  
  <p class="block antialiased font-sans text-sm font-normal leading-normal text-blue-gray-700">
    Manage your account information, including your email address and password.
  </p>
  
  <%# Email & Password Update Form %>
    <%= form_with model: current_user, as: :user, url: '/users', html: { method: :put, class: 'space-y-6', data: { turbo: true } } do |form| %>
    <%# Email Field %>
    <%= render 'shared/form_field', 
        form: form, 
        field_name: :email, 
        field_type: 'email', 
        required: true, 
        placeholder: 'Enter your email address' %>
    
    <%# Pending Reconfirmation Notice %>
    <% if current_user.respond_to?(:pending_reconfirmation?) && current_user.pending_reconfirmation? %>
      <div class="rounded-lg bg-yellow-50 border border-yellow-200 p-4">
        <div class="flex items-start">
          <svg class="h-5 w-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div class="ml-3">
            <p class="text-sm font-medium text-yellow-800">
              Currently waiting confirmation for: <strong><%= current_user.unconfirmed_email %></strong>
            </p>
          </div>
        </div>
      </div>
    <% end %>
    
    <%# Password Field (optional - leave blank to keep current) %>
    <div>
      <%= form.label :password, "New password", class: "block antialiased font-sans text-sm font-medium leading-relaxed text-blue-gray-900 mb-2" %>
      <p class="block antialiased font-sans text-xs font-normal leading-normal text-blue-gray-600 mb-2">
        (leave blank if you don't want to change it)
      </p>
      <% if @minimum_password_length %>
        <p class="block antialiased font-sans text-xs font-normal leading-normal text-blue-gray-600 mb-2">
          <%= @minimum_password_length %> characters minimum
        </p>
      <% end %>
      <% field_errors = form.object.present? && form.object.errors[:password].present? ? form.object.errors[:password] : [] %>
      <% field_id = "#{form.object_name}_password" %>
      <% base_input_classes = "mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-20 #{field_errors.any? ? 'border-red-500 focus:border-red-500 focus:ring-red-500' : ''}" %>
      <% aria_attrs = field_errors.any? ? { 'aria-describedby': "#{field_id}_errors" } : {} %>
      <%= form.password_field :password, 
          id: field_id,
          class: base_input_classes,
          required: false,
          placeholder: 'Enter new password (optional)',
          autocomplete: "new-password",
          **aria_attrs %>
      <% if field_errors.any? %>
        <%= render 'shared/error_message', errors: field_errors, field_id: "#{field_id}_errors" %>
      <% end %>
    </div>
    
    <%# Password Confirmation Field %>
    <%= render 'shared/form_field', 
        form: form, 
        field_name: :password_confirmation, 
        field_type: 'password', 
        required: false, 
        placeholder: 'Confirm new password' %>
    
    <%# Current Password Field (required only when changing password) %>
    <div id="current-password-field" class="hidden">
      <%= render 'shared/form_field', 
          form: form, 
          field_name: :current_password, 
          field_type: 'password', 
          required: true, 
          placeholder: 'Enter current password to confirm password change' %>
    </div>
    
    <%# Form Actions %>
    <%= render 'shared/form_actions', submit_text: 'Update Account' %>
  <% end %>
  
  <%# JavaScript to show/hide current password field based on password input %>
  <script>
    (function() {
      let listenersAttached = false;
      
      function setupPasswordToggle() {
        const passwordField = document.getElementById('user_password');
        const passwordConfirmationField = document.getElementById('user_password_confirmation');
        const currentPasswordField = document.getElementById('current-password-field');
        const currentPasswordInput = document.getElementById('user_current_password');
        
        if (!passwordField || !currentPasswordField) return;
        
        // Only attach listeners once per field
        if (listenersAttached && passwordField.dataset.listenerAttached === 'true') return;
        
        function toggleCurrentPasswordField() {
          const passwordValue = passwordField.value.trim();
          const passwordConfirmationValue = passwordConfirmationField ? passwordConfirmationField.value.trim() : '';
          
          if (passwordValue || passwordConfirmationValue) {
            // Show current password field if password is being changed
            currentPasswordField.classList.remove('hidden');
            if (currentPasswordInput) {
              currentPasswordInput.setAttribute('required', 'required');
            }
          } else {
            // Hide current password field if only email is being updated
            currentPasswordField.classList.add('hidden');
            if (currentPasswordInput) {
              currentPasswordInput.removeAttribute('required');
              currentPasswordInput.value = '';
            }
          }
        }
        
        // Attach event listeners
        passwordField.addEventListener('input', toggleCurrentPasswordField);
        passwordField.addEventListener('change', toggleCurrentPasswordField);
        passwordField.dataset.listenerAttached = 'true';
        
        if (passwordConfirmationField) {
          passwordConfirmationField.addEventListener('input', toggleCurrentPasswordField);
          passwordConfirmationField.addEventListener('change', toggleCurrentPasswordField);
          passwordConfirmationField.dataset.listenerAttached = 'true';
        }
        
        // Check initial state
        toggleCurrentPasswordField();
        listenersAttached = true;
      }
      
      // Run immediately if DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupPasswordToggle);
      } else {
        setupPasswordToggle();
      }
      
      // Also run after Turbo navigation
      document.addEventListener('turbo:load', function() {
        listenersAttached = false;
        setupPasswordToggle();
      });
      document.addEventListener('turbo:frame-load', function() {
        listenersAttached = false;
        setupPasswordToggle();
      });
    })();
  </script>
</div>
