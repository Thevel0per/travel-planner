<%# Note Item Partial %>
<%# Displays a single note with content and timestamps, with edit and delete functionality %>
<%# Usage: render 'trips/note_item', note: note %>
<% trip = note.trip %>

<div id="note_<%= note.id %>" 
     class="bg-gray-50 rounded-lg p-4 border border-gray-200"
     data-controller="note-edit"
     data-action="turbo:submit-end->note-edit#handleFormSubmit">
  
  <!-- Display Mode (default) -->
  <div data-note-edit-target="displayMode" aria-hidden="false">
    <!-- Note Content -->
    <div class="mb-3">
      <p class="text-sm antialiased font-normal leading-relaxed text-gray-900 whitespace-pre-wrap">
        <%= simple_format(note.content, {}, wrapper_tag: 'div') %>
      </p>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
      <!-- Timestamp -->
      <div class="flex items-center text-xs text-gray-500">
        <svg class="w-3 h-3 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <time datetime="<%= note.created_at.iso8601 %>">
          <%= time_ago_in_words(note.created_at) %> ago
        </time>
        <% if note.updated_at != note.created_at %>
          <span class="mx-2">â€¢</span>
          <span class="text-gray-400">Updated <%= time_ago_in_words(note.updated_at) %> ago</span>
        <% end %>
      </div>
      
      <!-- Edit and Delete Buttons -->
      <div class="flex items-center gap-2">
        <button 
          type="button"
          data-note-edit-target="editButton"
          data-action="click->note-edit#edit"
          class="inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 shadow-sm transition-all hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-20 active:bg-gray-100"
          aria-label="Edit note">
          <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          Edit
        </button>
        
        <%= button_to trip_note_path(trip, note),
            method: :delete,
            form: { 
              class: "inline-block"
            },
            class: "inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-xs font-medium text-red-700 bg-white border border-red-300 shadow-sm transition-all hover:bg-red-50 hover:border-red-400 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-20 active:bg-red-100 disabled:opacity-50 disabled:cursor-not-allowed",
            data: {
              note_edit_target: "deleteButton",
              action: "click->note-edit#delete"
            },
            aria: { label: "Delete note" } do %>
          <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Delete
        <% end %>
      </div>
    </div>
  </div>
  
  <!-- Edit Mode (initially hidden) -->
  <div data-note-edit-target="editMode" class="hidden" aria-hidden="true">
    <%= form_with model: [trip, note],
        local: false,
        class: "space-y-4",
        data: {
          note_edit_target: "form",
          action: "submit->note-edit#handleSubmit"
        } do |form| %>
      
      <!-- Content Field -->
      <div>
        <%= form.label :content, "Note Content", class: "block antialiased font-sans text-sm font-medium leading-relaxed text-blue-gray-900 mb-2 after:content-['*'] after:text-red-500 after:ml-1" %>
        
        <% field_errors = note.errors[:content].present? ? note.errors[:content] : [] %>
        <% field_id = "note_#{note.id}_content" %>
        <% base_textarea_classes = "mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-20 #{field_errors.any? ? 'border-red-500 focus:border-red-500 focus:ring-red-500' : ''}" %>
        
        <%= form.text_area :content,
            id: field_id,
            class: base_textarea_classes,
            required: true,
            placeholder: "Enter your note here...",
            rows: 4,
            maxlength: 10000,
            data: {
              note_edit_target: "textarea"
            },
            aria: {
              describedby: field_errors.any? ? "#{field_id}_errors" : nil
            }.compact %>
        
        <!-- Error Messages -->
        <% if field_errors.any? %>
          <%= render 'shared/error_message', errors: field_errors, field_id: "#{field_id}_errors" %>
        <% end %>
        
        <!-- Client-side error container (for Stimulus) -->
        <div data-note-edit-target="errorContainer" class="hidden mt-2 text-sm text-red-600" role="alert"></div>
      </div>
      
      <!-- Form Actions -->
      <div class="flex items-center justify-end gap-2 pt-2">
        <button 
          type="button"
          data-note-edit-target="cancelButton"
          data-action="click->note-edit#cancel"
          class="inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 shadow-sm transition-all hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-20 active:bg-gray-100">
          Cancel
        </button>
        
        <button 
          type="submit"
          data-note-edit-target="saveButton"
          class="inline-flex items-center justify-center rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white shadow-md shadow-blue-500/20 transition-all hover:shadow-lg hover:shadow-blue-500/40 focus:opacity-[0.85] focus:shadow-none active:opacity-[0.85] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none">
          Save
        </button>
      </div>
    <% end %>
  </div>
</div>


