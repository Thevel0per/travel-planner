<%# Turbo Stream for note creation %>
<%# Updates notes list and form based on success or validation errors %>

<% if @note.persisted? && @note.errors.empty? %>
  <%# Reload the trip to get updated notes list %>
  <% @trip.reload %>
  
  <%# Update the entire notes list to handle both empty and populated states %>
  <%= turbo_stream.update "notes_list" do %>
    <%= render 'trips/notes_list', notes: @trip.notes.order(created_at: :desc) %>
  <% end %>
  
  <%# Reset the form - replace inner content only (form already has the wrapper div) %>
  <%= turbo_stream.update "new_note_form" do %>
    <h3 class="text-sm font-medium text-gray-900 mb-4">Add a Note</h3>
    
    <%= form_with model: [@trip, Note.new], 
        local: false, 
        class: 'space-y-4' do |form| %>
      
      <!-- Content Field -->
      <%= render 'shared/form_field', 
          form: form, 
          field_name: :content, 
          field_type: 'textarea', 
          required: true, 
          maxlength: 10000,
          textarea_rows: 4,
          placeholder: 'Enter your note here...' %>
      
      <!-- Submit Button -->
      <div class="flex justify-end">
        <button 
          type="submit"
          class="inline-flex items-center justify-center rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white shadow-md shadow-blue-500/20 transition-all hover:shadow-lg hover:shadow-blue-500/40 focus:opacity-[0.85] focus:shadow-none active:opacity-[0.85] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
          data-ripple="light">
          Add Note
        </button>
      </div>
    <% end %>
  <% end %>
  
  <%# Update toast container to show flash message %>
  <%= turbo_stream.update "toast-container" do %>
    <%= render 'shared/toast_container' %>
  <% end %>
<% else %>
  <%# Re-render form with validation errors %>
  <%= turbo_stream.update "new_note_form" do %>
    <h3 class="text-sm font-medium text-gray-900 mb-4">Add a Note</h3>
    
    <%= form_with model: [@trip, @note], 
        local: false, 
        class: 'space-y-4' do |form| %>
      
      <!-- Content Field -->
      <%= render 'shared/form_field', 
          form: form, 
          field_name: :content, 
          field_type: 'textarea', 
          required: true, 
          maxlength: 10000,
          textarea_rows: 4,
          placeholder: 'Enter your note here...' %>
      
      <!-- Submit Button -->
      <div class="flex justify-end">
        <button 
          type="submit"
          class="inline-flex items-center justify-center rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white shadow-md shadow-blue-500/20 transition-all hover:shadow-lg hover:shadow-blue-500/40 focus:opacity-[0.85] focus:shadow-none active:opacity-[0.85] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
          data-ripple="light">
          Add Note
        </button>
      </div>
    <% end %>
  <% end %>
<% end %>

